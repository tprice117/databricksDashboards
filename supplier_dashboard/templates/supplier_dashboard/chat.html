{% extends 'supplier_dashboard/supplier_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
    Chat
{% endblock %}
{% block javascript %}
    <script>
        // Function to scroll to the bottom
        function scrollToBottom() {
            console.log("scrollToBottom");
            let responseElement = document.getElementById("booking-chat");
            responseElement.scrollTop = responseElement.scrollHeight;
            // Scroll to the bottom of the page
            window.scrollTo(0, document.body.scrollHeight);
        }
        
        function autoResize(textarea) {
            textarea.style.height = "auto";
            textarea.style.height = textarea.scrollHeight + 10 + "px";
        }
        
        // Initial call to set the initial height
        document.addEventListener("DOMContentLoaded", function () {
            var textarea = document.getElementById("chat-message-input");
            autoResize(textarea);
            scrollToBottom();
        });
        document.body.addEventListener("htmx:afterSettle", function (event) {
            scrollToBottom();
        });
    </script>
{% endblock %}
{% block stylesheet %}
    <style>
        #booking-chat {
            min-height: 100px;
            border-top: 1px dotted gray;
            overflow: hidden;
            max-height: 65vh;
            overflow-y: scroll;
        }
        #chat-message-input {
            box-sizing: border-box;
            width: 100%;
            resize: none;
            overflow: hidden;
            min-height: 60px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
        }
        .intercom-container {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: box-shadow 0.1s ease;
            margin: 8px 0;
            box-shadow: 0 0 4px transparent;
        }
        .intercom-container > img {
            border-radius: 8px 8px 0 0;
            width: 100%;
            height: auto;
        }
        .intercom-interblocks-link-content-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .intercom-interblocks-link-author {
            font-size: 12px;
            color: #6c757d;
            display: flex;
            justify-content: end;
            align-items: center;
            margin-top: 8px;
        }
        .intercom-interblocks-link-author-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .intercom-interblocks-link-author-summary {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .intercom-interblocks-link-author-avatar-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        .intercom-interblocks-link-author-name {
            font-weight: 600;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <div class="d-sm-flex justify-content-between align-items-center mb-4">
            <h3 class="text-dark mb-0">Chat</h3>
        </div>
        <div class="row">
            <div class="col flex-grow-1 mb-4">
                <div class="card shadow m-auto border-start-primary" style="max-width: 850px;">
                    <div class="card-header py-3">
                        <div class="table-header-title">
                            <p class="text-primary m-0 fw-bold me-2">
                                {% if user.user_group.id == order.order_group.user.user_group.id %}
                                    Chat with seller: {{ order.order_group.seller_product_seller_location.seller_location.seller.name }}
                                {% else %}
                                    Chat with customer: {{ order.order_group.user.first_name }}
                                {% endif %}
                            </p>
                            <span class="htmx-indicator" id="htmx-indicator-status"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <span class="d-none" id="htmx-chat-get" hx-get="{% url 'supplier_chat' order_id=order.id %}?last={{ last_message_time|urlencode }}" hx-trigger="every 5s" hx-swap="innerHTML" hx-target="#booking-chat"></span>
                        <div id="booking-chat">
                            {% for message in chat %}
                                {% if message.is_admin %}
                                    <div class="row align-items-center no-gutters" style="margin-top: 24px;">
                                        <div class="col-8 mx-auto">
                                            <div class="card" style="background: var(--bs-warning-border-subtle);color: var(--bs-primary-text-emphasis);">
                                                <div class="card-body">{{ message.body|safe }}</div>
                                            </div>
                                            <div class="row float-end">
                                                <div class="col">
                                                    <small class="form-text">{{ message.created_at|timesince }} ago&nbsp;&nbsp;</small>
                                                    <small class="form-text">Downstream&nbsp;&nbsp;</small>
                                                    {% if message.photo %}
                                                        <img class="rounded-circle" width="100" height="80" style="width: 20px;height: 20px;" src="{{ message.photo.url }}" />
                                                    {% else %}
                                                        <img class="rounded-circle" width="100" height="80" style="width: 20px;height: 20px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAABbElEQVR4AWNhLC9lYGBkYPjPAAIEGYwsDH/+MpACgBr+YBP/DzYSq4bff5AtZWdmkhIQYmRk+PXnz/MPH/9CpVBs+A3naElIlri7X3z06N///1xs7KoS4uvOnd1+5fJ/JNuANiA0pNrYZC1YoCohAbTk1aeP3Vs3l3p6ff/2ff/NGyhO+s/wnxFsBiPQ5F8/Wf7+Yf73x0xONsLUpGrFiq6oqP1gS8DB9J/l/+9fjDBvzt2zuz8m9urjJ//+/1uwf3+Bp6cUL+/n79+Zf/3+ywj1JQvjL6iTgJwrd+/lzpghzs8PZP/4+k0UqPrzZxagWUjOhvsBFI4Jrq76ioqQcOFkYd1/+dK/Xz+Z//37BwyY/9CARgml+du3AT0Ddi7QtQwSQoITUtLqFy1ADhigHxARF+XkpC2vAPY+CHz+9rV8xvTXHz8ixwULI5INy3fuhDFhfgRHHHKco9hADADaQIKG/yAb/vzGTMp4AACCn6yMFV/i0QAAAABJRU5ErkJggg==" />
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% elif message.sent_by_current_user %}
                                    <div class="row align-items-center no-gutters" style="margin-top: 24px;">
                                        <div class="col-8 ms-auto me-2">
                                            <div class="card" style="background: var(--bs-secondary-border-subtle);color: var(--bs-primary-text-emphasis);">
                                                <div class="card-body">{{ message.body|safe }}</div>
                                            </div>
                                            <div class="row float-end">
                                                <div class="col">
                                                    <small class="form-text">{{ message.created_at|timesince }} ago&nbsp;&nbsp;</small>
                                                    <small class="form-text">Me&nbsp;&nbsp;</small>
                                                    {% if message.photo %}
                                                        <img class="rounded-circle" width="100" height="80" style="width: 20px;height: 20px;" src="{{ message.photo.url }}" />
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="row align-items-center no-gutters" style="margin-top: 24px;">
                                        <div class="col-8 me-2">
                                            <div class="card" style="background: var(--bs-primary-bg-subtle);color: var(--bs-primary-text-emphasis);">
                                                <div class="card-body">{{ message.body|safe }}</div>
                                            </div>
                                            <div class="row float-end">
                                                <div class="col">
                                                    <small class="form-text">{{ message.created_at|timesince }} ago&nbsp;&nbsp;</small>
                                                    <small class="form-text">{{ message.author }}&nbsp;&nbsp;</small>
                                                    {% if message.photo %}
                                                        <img class="rounded-circle" width="100" height="80" style="width: 20px;height: 20px;" src="{{ message.photo.url }}" />
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <form id="booking-chat-form" action="{% url 'supplier_chat' order_id=order.id %}" method="post" hx-boost="true" hx-target="#booking-chat" hx-swap="innerHTML" enctype="multipart/form-data" hx-disabled-elt="button">
                            {% csrf_token %}
                            <div class="row" style="margin-top: 16px;padding-top: 16px;border-top-style: solid;border-top-color: var(--bs-primary);">
                                <div class="col d-md-flex justify-content-md-start">
                                    {{ message_form }}
                                    <button class="btn btn-primary" type="submit">
                                        Send
                                        <span class="htmx-indicator" id="htmx-indicator-loading"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars.svg' %}" /></span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
