{% extends 'supplier_dashboard/supplier_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
    Chat
{% endblock %}
{% block javascript %}
    <script>
        // Function to scroll to the bottom
        function scrollToBottom() {
            console.log("scrollToBottom");
            let responseElement = document.getElementById("booking-chat");
            responseElement.scrollTop = responseElement.scrollHeight;
            // Scroll to the bottom of the page
            window.scrollTo(0, document.body.scrollHeight);
        }
        
        function autoResize(textarea) {
            textarea.style.height = "auto";
            textarea.style.height = textarea.scrollHeight + 10 + "px";
        }
        
        // Initial call to set the initial height
        document.addEventListener("DOMContentLoaded", function () {
            var textarea = document.getElementById("chat-message-input");
            autoResize(textarea);
            scrollToBottom();
        });
    </script>
{% endblock %}
{% block stylesheet %}
    <style>
        #booking-chat {
            min-height: 100px;
            border-top: 1px dotted gray;
            overflow: hidden;
            max-height: 65vh;
            overflow-y: scroll;
        }
        #chat-message-input {
            box-sizing: border-box;
            width: 100%;
            resize: none;
            overflow: hidden;
            min-height: 60px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <div class="d-sm-flex justify-content-between align-items-center mb-4">
            <h3 class="text-dark mb-0">Chat</h3>
        </div>
        <div class="row">
            <div class="col flex-grow-1 mb-4">
                <div class="card shadow m-auto border-start-primary" style="max-width: 850px;">
                    <div class="card-header py-3">
                        <div class="table-header-title">
                            <p class="text-primary m-0 fw-bold me-2">
                                {% if user.user_group.id == order.order_group.user.user_group.id %}
                                    Chat with seller: {{ order.order_group.seller_product_seller_location.seller_location.seller.name }}
                                {% else %}
                                    Chat with customer: {{ order.order_group.user.first_name }}
                                {% endif %}
                            </p>
                            <span class="htmx-indicator" id="htmx-indicator-status"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <span class="d-none" id="htmx-chat-get" hx-get="{% url 'supplier_chat' order_id=order.id %}?last={{ last_message_time|urlencode }}" hx-trigger="every 5s" hx-swap="innerHTML" hx-target="#booking-chat"></span>
                        <div id="booking-chat">
                            {% for message in chat %}
                                {% if message.is_admin %}
                                    <div class="row align-items-center no-gutters" style="margin-top: 24px;">
                                        <div class="col-8 mx-auto">
                                            <div class="card" style="background: var(--bs-warning-border-subtle);color: var(--bs-primary-text-emphasis);">
                                                <div class="card-body">
                                                    <p class="card-text">{{ message.body }}</p>
                                                </div>
                                            </div>
                                            <div class="row float-end">
                                                <div class="col">
                                                    <small class="form-text">{{ message.created_at|timesince }} ago&nbsp;&nbsp;</small>
                                                    <small class="form-text">{{ message.author }}&nbsp;&nbsp;</small>
                                                    {% if message.photo %}
                                                        <img class="rounded-circle" width="100" height="80" style="width: 20px;height: 20px;" src="{{ message.photo.url }}" />
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% elif message.sent_by_current_user %}
                                    <div class="row align-items-center no-gutters" style="margin-top: 24px;">
                                        <div class="col-8 ms-auto me-2">
                                            <div class="card" style="background: var(--bs-secondary-border-subtle);color: var(--bs-primary-text-emphasis);">
                                                <div class="card-body">
                                                    <p class="card-text">{{ message.body }}</p>
                                                </div>
                                            </div>
                                            <div class="row float-end">
                                                <div class="col">
                                                    <small class="form-text">{{ message.created_at|timesince }} ago&nbsp;&nbsp;</small>
                                                    <small class="form-text">{{ message.author }}&nbsp;&nbsp;</small>
                                                    {% if message.photo %}
                                                        <img class="rounded-circle" width="100" height="80" style="width: 20px;height: 20px;" src="{{ message.photo.url }}" />
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="row align-items-center no-gutters" style="margin-top: 24px;">
                                        <div class="col-8 me-2">
                                            <div class="card" style="background: var(--bs-primary-bg-subtle);color: var(--bs-primary-text-emphasis);">
                                                <div class="card-body">
                                                    <p class="card-text">{{ message.body }}</p>
                                                </div>
                                            </div>
                                            <div class="row float-end">
                                                <div class="col">
                                                    <small class="form-text">{{ message.created_at|timesince }} ago&nbsp;&nbsp;</small>
                                                    <small class="form-text">{{ message.author }}&nbsp;&nbsp;</small>
                                                    {% if message.photo %}
                                                        <img class="rounded-circle" width="100" height="80" style="width: 20px;height: 20px;" src="{{ message.photo.url }}" />
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <form action="{% url 'supplier_chat' order_id=order.id %}" method="post">
                            {% csrf_token %}
                            <div class="row" style="margin-top: 16px;padding-top: 16px;border-top-style: solid;border-top-color: var(--bs-primary);">
                                <div class="col d-md-flex justify-content-md-start">
                                    {{ message_form }}
                                    <button class="btn btn-primary" type="submit">Send</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
