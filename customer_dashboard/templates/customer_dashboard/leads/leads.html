{% extends 'customer_dashboard/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
  Leads
{% endblock %}
{% block stylesheet %}
  <style></style>
{% endblock %}
{% block javascript %}
  <script defer src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
  <script>
    htmx.onLoad(function (content) {
      const sortables = content.querySelectorAll('.sortable')
      const selectableStatuses = '{{ selectable_statuses|escapejs }}'
      // prevent multiple requests from being sent concurrently
      let isRequestInProgress = false
    
      sortables.forEach((sortable) => {
        const instance = new Sortable(sortable, {
          group: 'kanban',
          sort: false,
          onMove: function (evt) {
            // prevent moving to a non-selectable status
            return selectableStatuses.includes(evt.to.id) && !isRequestInProgress
          },
          onEnd: function (evt) {
            if (selectableStatuses.includes(evt.to.id) && evt.from.id !== evt.to.id) {
              const status = document.getElementById('status')
              const movedCard = document.getElementById('movedCard')
              status.value = evt.to.id
              movedCard.value = evt.item.dataset.leadId
              htmx.trigger('#board', 'cardMoved')
            } else {
              evt.preventDefault()
            }
          }
        })
        htmx.on('htmx:beforeRequest', function () {
          isRequestInProgress = true
          instance.option('disabled', true)
        })
    
        htmx.on('htmx:afterRequest', function () {
          isRequestInProgress = false
          instance.option('disabled', false)
        })
      })
    })
  </script>
{% endblock %}
{% block content %}
  <div class="container-fluid">
    {% comment %} <div class="d-flex justify-content-end align-items-center mb-3">
      <button hx-get="" hx-target="#modals-here" hx-trigger="click" data-bs-toggle="modal" data-bs-target="#modals-here" class="btn btn-primary"><i class="fas fa-plus-square fa-sm text-white-50"></i>&nbsp;New Lead</button>
    </div> {% endcomment %}
    <form hx-post="{% url 'customer_leads_card_move' %}" hx-trigger="cardMoved" hx-target="#board" hx-push-url="false">
      <input id="status" type="hidden" name="status" />
      <input id="movedCard" type="hidden" name="lead_id" />
      <div class="board" id="board">
        {% include 'customer_dashboard/leads/leads_kanban_board.html' with board=board %}
      </div>
    </form>
  </div>
{% endblock %}
{% block modals %}
  <div id="card-modal" class="modal modal-blur fade" style="display: none" aria-hidden="false" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content"></div>
    </div>
  </div>
{% endblock %}
