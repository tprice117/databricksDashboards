{% extends 'customer_dashboard/base.html' %}
{% load static %}
{% load humanize %}
{% load sales_stream_tags %}
{% block title %}
  Lead Details
{% endblock %}
{% block stylesheet %}
  <style></style>
{% endblock %}
{% block javascript %}
  <script>
    const inputOptions = {}
    document
      .getElementById('lost-reason')
      .querySelectorAll('option')
      .forEach((option) => {
        inputOptions[option.value] = option.text
      })
    
    function disableSubmitButton(form) {
      const submitButton = form.querySelector('button[type="submit"]')
      submitButton.disabled = true
    }
    
    function markAsJunk() {
      // Send a modal popup asking for Lost Reason
      Swal.fire({
        title: 'Please select the reason for losing this lead:',
        input: 'select',
        inputOptions: inputOptions,
        inputPlaceholder: 'Select a reason...',
        showCancelButton: true,
        inputValidator: (value) => {
          if (!value) {
            return 'Please select a reason.'
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          document.getElementById('lost-reason').value = result.value
          document.getElementById('mark-as-junk-form').submit()
        }
      })
    }
    
    // Lead Detail Form START
    // Removes the dropdown results from an element
    function removeAutocompleteDropdown() {
      let dropdownItems = document.querySelectorAll('.my-dropdown-item')
      dropdownItems.forEach(function (item) {
        item.remove()
      })
    }
    
    // Sets dropdown selection to input[#id_user_address] value
    function addUserAddressAutocompleteListeners() {
      let dropdownItems = document.querySelectorAll('.my-dropdown-item')
      dropdownItems.forEach(function (item) {
        if (item.getAttribute('data-id') === '') {
          // Empty element
          document.getElementById('id_user_address').value = null
          return
        }
        item.addEventListener('click', function () {
          // Update the display field with the user_address's name
          document.getElementById('user_address-search').value = item.getAttribute('data-name')
          // Update the hidden field with the user_address's ID
          document.getElementById('id_user_address').value = item.getAttribute('data-id')
          removeAutocompleteDropdown()
        })
      })
    }
    
    // On Click event, close the dropdown unless the user is clicking on the search input
    document.addEventListener('click', function (e) {
      if (e.target != document.getElementById('user_address-search')) {
        removeAutocompleteDropdown()
      }
    })
    
    document.addEventListener('DOMContentLoaded', function () {
      // Clear the input field if the user clears the search field
      const userAddressInput = document.getElementById('user_address-search')
      if (userAddressInput) {
        userAddressInput.addEventListener('input', function (e) {
          if (!e.currentTarget.value && !e.inputType) {
            document.getElementById('id_user_address').value = null
          }
        })
      }
    
      // Make the user select searchable
      const userSelect = content.querySelectorAll('.form-select').forEach((userSelect) => {
        new Choices(userSelect, {
          searchEnabled: true,
          searchChoices: true,
          removeItemButton: true,
          itemSelectText: '',
          noResultsText: 'No results found.',
          shouldSort: false
        })
      })
    
      // Prevent the form from submitting when Enter is pressed
      // This is so the form isn't accidently submitted while searching for an address
      const form = content.querySelector('form')
      if (form) {
        form.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault()
          }
        })
      }
    })
    
    htmx.onLoad(function (content) {
      addUserAddressAutocompleteListeners()
    })
    // Lead Detail Form END
  </script>
{% endblock %}
{% block content %}
  <div class="container-fluid">
    <h4 class="text-dark mb-3"><strong>Lead Details</strong></h4>
    <!-- Lead Header -->
    <div class="card border-0 content mb-3">
      <div class="card-header border-0 bg-white">
        <div class="row align-items-center px-2">
          {% if lead.user.photo %}
            <img class="border rounded-circle img-profile object-fit-cover p-0" style="height: 4rem; width: 4rem;" src="{{ lead.user.photo.url }}" />
          {% else %}
            <span class="border rounded-circle img-profile d-flex justify-content-center align-items-center" style="height: 4rem; width: 4rem;"><i class="fas fa-user fa-2x"></i></span>
          {% endif %}
          <div class="col">
            <h5 class="text-primary mb-1"><strong>{{ lead.user.full_name|default_if_none:lead.user.email }}</strong></h5>
            {% if lead.user_address %}
              <h5 class="text-dark mb-1"><a href="{% url 'customer_location_detail' lead.user_address_id %}" class="text-decoration-none">{{ lead.user_address }}</a></h5>
            {% else %}
              <h6 class="text-muted mb-1">----</h6>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="card-body p-3 text-dark">
        <div class="row">
          <div class="col me-3">
            <h6 class="mb-1"><strong>Lead Owner</strong></h6>
            <h6 class="mb-1">
              {% if lead.owner %}
                {{ lead.owner.full_name|default:lead.owner.email }}
              {% else %}
                Unassigned
              {% endif %}
            </h6>
          </div>
          <div class="col me-3">
            <h6 class="mb-1"><strong>Phone</strong></h6>
            <h6 class="mb-1">{{ lead.user.phone|default:'-----' }}</h6>
          </div>
          <div class="col me-3">
            <h6 class="mb-1"><strong>Email</strong></h6>
            <h6 class="mb-1">{{ lead.user.email }}</h6>
          </div>
          <div class="col me-3">
            <h6 class="mb-1"><strong>Lead Type</strong></h6>
            <h6 class="mb-1">{{ lead.get_type_display }}</h6>
          </div>
        </div>
      </div>
    </div>
    <!-- Lead Status -->
    <div class="card content border-0 mb-3">
      <div class="card-body">
        <div class="row">
          <div class="col-md-10 mb-md-0 mb-1">
            <div class="progress small" style="height: 2rem;">
              {% with status_count=lead_statuses|length %}
                {% for status, label in lead_statuses %}
                  <!-- prettier-ignore -->
                  {% if lead.status == 'junk' %}
              <div 
              class="progress-bar p-3 text-truncate {% if status == lead.status %} progress-bar bg-danger {% else %} bg-light text-dark {% endif %}" 
              role="progressbar" 
              style="width: {% widthratio 1 status_count 100 %}%" 
              aria-valuenow="{{ forloop.counter }}" 
              aria-valuemin="1" 
              aria-valuemax="{{ status_count }}">
              {{ label }}
            </div>
            {% else %}
            <div 
            class="progress-bar p-3 text-truncate {% if status == lead.status %}bg-primary{% elif forloop.counter0 < lead_status_index %}bg-secondary {% else %} bg-light text-dark{% endif %}" 
            role="progressbar" 
            style="width: {% widthratio 1 status_count 100 %}%" 
            aria-valuenow="{{ forloop.counter }}" 
            aria-valuemin="1" 
            aria-valuemax="{{ status_count }}">
            {{ label }}
          </div>
            {% endif %}
                {% endfor %}
              {% endwith %}
            </div>
          </div>
          <div class="col-md-2">
            <form id="mark-as-junk-form" method="post">
              {% csrf_token %}
              <input type="hidden" name="update_status" />
              <input type="hidden" name="status" value="junk" />
              <select id="lost-reason" class="d-none" name="lost_reason">
                {% for reason, label in lost_reasons.items %}
                  <option value="{{ reason }}">{{ label }}</option>
                {% endfor %}
              </select>
              {% if lead.status == 'junk' %}
                <button class="btn btn-danger btn-sm w-100 disabled" disabled><i class="fas fa-times me-3"></i>Mark as Junk</button>
              {% else %}
                <button class="btn btn-danger btn-sm w-100" onclick="markAsJunk(); return false;"><i class="fas fa-times me-3"></i>Mark as Junk</button>
              {% endif %}
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Lead Information -->
    <div class="row">
      <!-- Details -->
      <div class="col-xl-8 col-md-6">
        <div class="card content border-0 mb-3">
          <div class="card-body">
            <ul class="nav nav-tabs" id="leadTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" style="background-color: inherit;" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Details</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" style="background-color: inherit;" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab" aria-controls="activity" aria-selected="false">Activity</button>
              </li>
            </ul>
            <div class="tab-content p-3" id="leadTabContent">
              <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                {% if lead.lost_reason %}
                  <div class="alert alert-danger" role="alert">
                    <h6 class="alert-heading mb-0"><strong>Lead Lost:</strong> {{ lead.get_lost_reason_display }}</h6>
                  </div>
                {% endif %}
                {% if lead.status == 'converted' %}
                  <div class="alert alert-success" role="alert">
                    <h6 class="alert-heading mb-0"><strong>Lead Converted</strong></h6>
                  </div>
                {% endif %}
                <!-- Lead Details Display -->
                <div id="text-details">
                  <div class="d-flex flex-row-reverse mb-2">
                    <button class="btn btn-primary btn-sm px-3 py-0 rounded-3" onclick="toggleEdit('details'); return false;" title="Edit Details">Edit</button>
                  </div>
                  <div class="row">
                    <div class="col">
                      {% with user=lead.user %}
                        <table class="table small" style="--bs-table-bg: inherit;">
                          <tbody>
                            <tr>
                              <td>
                                <b>Name</b>
                              </td>
                              <td>{{ user.full_name|default:'' }}</td>
                            </tr>
                            <tr>
                              <td>
                                <b>Email</b>
                              </td>
                              <td>{{ user.email }}</td>
                            </tr>
                            <tr>
                              <td>
                                <b>Address</b>
                              </td>
                              <td>{{ lead.user_address|default:'' }}</td>
                            </tr>
                            <tr>
                              <td>
                                <b>Company</b>
                              </td>
                              <td>{{ user.user_group|default:'' }}</td>
                            </tr>
                            <tr>
                              <td>
                                <b>Phone</b>
                              </td>
                              <td>{{ user.phone|default:'' }}</td>
                            </tr>
                            <tr>
                              <td>
                                <b>Estimated Conversion Date</b>
                              </td>
                              <td>{{ lead.est_conversion_date }}</td>
                            </tr>
                            <tr>
                              <td>
                                <b>Estimated Value</b>
                              </td>
                              <td>{{ lead.est_value|currency }}</td>
                            </tr>
                          </tbody>
                        </table>
                      {% endwith %}
                    </div>
                    <div class="col">
                      <table class="table small" style="--bs-table-bg: inherit;">
                        <tbody>
                          <tr>
                            <td>
                              <b>Lead Number</b>
                            </td>
                            <td>{{ lead.id }}</td>
                          </tr>
                          <tr>
                            <td>
                              <b>Lead Status</b>
                            </td>
                            <td>{{ lead.get_status_display }}</td>
                          </tr>
                          <tr>
                            <td>
                              <b>Lead Owner</b>
                            </td>
                            <td>
                              {% if lead.owner %}
                                {{ lead.owner.full_name|default:lead.owner.email }}
                              {% endif %}
                            </td>
                          </tr>
                          <tr>
                            <td>
                              <b>Lead Type</b>
                            </td>
                            <td>{{ lead.get_type_display }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <!-- Lead Details Form -->
                <div id="text-edit-details" class="d-none">
                  <form method="post">
                    {% csrf_token %}
                    {% for hidden in lead_form.hidden_fields %}
                      {{ hidden }}
                    {% endfor %}
                    <div class="d-flex flex-row-reverse">
                      <button class="btn btn-primary btn-sm" type="submit" title="Save Details" name="lead-form">Save</button>
                      <button class="btn btn-danger btn-sm me-2" onclick="toggleEdit('details'); return false;" title="Cancel Edit"><i class="fas fa-times me-2"></i>Cancel</button>
                    </div>
                    <div class="row">
                      <div class="col">
                        {% with user=lead.user %}
                          <table class="table small" style="--bs-table-bg: inherit;">
                            <tbody>
                              <tr>
                                <td>
                                  <b>User</b>
                                </td>
                                <td>{{ lead_form.user }}</td>
                              </tr>
                              <tr>
                                <td>
                                  <b>Address</b>
                                  <span class="htmx-indicator" id="htmx-indicator-loading"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
                                </td>
                                <td>
                                  <div class="dropdown mb-3" hx-disabled-elt=".form-control, button">
                                    <!-- prettier-ignore -->
                                    <input id="user_address-search" class="form-control" autocomplete="off" type="search" name="q" value="{{ lead.user_address|default:'' }}" hx-get="{% url 'customer_user_address_search' %}" hx-trigger="input changed delay:500ms, search" hx-swap="innerHTML" hx-target="#user_address-search-results" hx-indicator="#htmx-indicator-loading" hx-include="#id_user" />
                                    {% comment %}Hidden input field for user_address ID is added by forms.py id=id_user_address{% endcomment %}
                                    <div class="dropdown-content" id="user_address-search-results"></div>
                                  </div>
                                </td>
                              </tr>
                              <tr>
                                <td>
                                  <b>Estimated Conversion Date</b>
                                </td>
                                <td>{{ lead_form.est_conversion_date }}</td>
                              </tr>
                              <tr>
                                <td>
                                  <b>Estimated Value</b>
                                </td>
                                <td>{{ lead_form.est_value }}</td>
                              </tr>
                            </tbody>
                          </table>
                        {% endwith %}
                      </div>
                      <div class="col">
                        <table class="table small" style="--bs-table-bg: inherit;">
                          <tbody>
                            <tr>
                              <td>
                                <b>Lead Number</b>
                              </td>
                              <td>{{ lead.id }}</td>
                            </tr>
                            <tr>
                              <td>
                                <b>Lead Status</b>
                              </td>
                              <td>{{ lead_form.status }}</td>
                            </tr>
                            <tr>
                              <td>
                                <b>Lead Owner</b>
                              </td>
                              <td>{{ lead_form.owner }}</td>
                            </tr>
                            <tr>
                              <td>
                                <b>Lead Type</b>
                              </td>
                              <td>{{ lead_form.type }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="tab-pane fade" id="activity" role="tabpanel" aria-labelledby="activity-tab">
                <h6 class="mb-1">No Logged Activity</h6>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Notes -->
      <div class="col-xl-4 col-md-6">
        <div class="card content border-0 mb-3">
          <div class="card-body">
            <h5 class="card-title mb-3 text-dark"><i class="fas fa-comments me-3"></i><strong>Lead Notes</strong></h5>
            <div id="lead-notes-formset" hx-push-url="false" hx-swap="innerHTML" hx-get="{% url 'customer_lead_notes' lead.id %}" hx-trigger="load" class="card-text" hx-indicator="#htmx-notes-initial">
              <div id="htmx-notes-initial" class="d-flex w-100 justify-content-center">
                <div class="spinner-border text-primary m-3" role="status"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
