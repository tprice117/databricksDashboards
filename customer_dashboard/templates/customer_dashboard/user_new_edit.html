{% extends 'customer_dashboard/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
    New User
{% endblock %}
{% block stylesheet %}
    <style>
        .my-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: block;
            position: absolute;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }
        
        .dropdown-content div {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }
        
        .dropdown-content div:hover {
            background-color: #ddd;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .my-dropdown-item {
            cursor: pointer;
        }
        .autocomplete-active {
            background-color: DodgerBlue !important;
            color: #ffffff;
        }
    </style>
{% endblock %}
{% block javascript %}
    <script>
        // Autocomplete for Customer/UserGroup search
        // Helped by: https://www.w3schools.com/howto/howto_js_autocomplete.asp
        var currentFocus;
        let usergroupInput = document.getElementById("usergroup-search");
        
        function removeAutocompleteDropdown() {
            let dropdownItems = document.querySelectorAll(".my-dropdown-item");
            dropdownItems.forEach(function (item) {
                item.remove();
            });
        }
        function addActive(x) {
            /*a function to classify an item as "active":*/
            if (!x) return false;
            /*start by removing the "active" class on all items:*/
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = x.length - 1;
            /*add class "autocomplete-active":*/
            x[currentFocus].classList.add("autocomplete-active");
        }
        function removeActive(x) {
            /*a function to remove the "active" class from all autocomplete items:*/
            for (var i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }
        /*execute a function when someone clicks in the document:*/
        document.addEventListener("click", function (e) {
            if (e.target != usergroupInput) {
                removeAutocompleteDropdown();
            }
        });
        function addUsergroupAutocompleteListeners() {
            currentFocus = -1;
            let dropdownItems = document.querySelectorAll(".my-dropdown-item");
            dropdownItems.forEach(function (item) {
                item.addEventListener("click", function () {
                    // Update the display field with the usergroup's name
                    document.getElementById("usergroup-search").value = item.getAttribute("data-name");
                    // Update the hidden field with the usergroup's ID
                    document.getElementById("usergroupId").value = item.getAttribute("data-id");
                    removeAutocompleteDropdown();
                });
            });
        }
        
        usergroupInput.addEventListener("keydown", function (e) {
            var x = document.getElementById("usergroup-search-results");
            if (x) x = x.getElementsByTagName("div");
            if (x) {
                if (e.keyCode == 40) {
                    /*If the arrow DOWN key is pressed, increase the currentFocus variable:*/
                    currentFocus++;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 38) {
                    /*If the arrow UP key is pressed, decrease the currentFocus variable:*/
                    currentFocus--;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 13) {
                    /*If the ENTER key is pressed, prevent the form from being submitted,*/
                    e.preventDefault();
                    if (currentFocus > -1) {
                        /*and simulate a click on the "active" item:*/
                        if (x) x[currentFocus].click();
                    }
                }
            }
        });
        
        // listen for page load event.
        document.addEventListener("DOMContentLoaded", function () {
            addUsergroupAutocompleteListeners();
        });
        // listen for htmx afterSettle event.
        document.body.addEventListener("htmx:afterSettle", function (event) {
            addUsergroupAutocompleteListeners();
        });
    </script>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <h3 class="text-dark mb-4">Create/Edit User</h3>
        <div class="card shadow">
            <div class="card-header py-3">
                <p class="text-primary m-0 fw-bold">User Data</p>
            </div>
            <div class="card-body">
                {% if not usergroup and user.is_staff %}
                    <div class="dropdown mb-3">
                        <label for="companies-search-filter" class="form-label">Select Customer <span class="htmx-indicator" id="htmx-indicator-loading"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span></label>
                        <input id="usergroup-search" form="userForm" class="form-control" autocomplete="off" type="search" name="search" required="true" hx-post="{% url 'customer_search_selection' %}" hx-trigger="input changed delay:500ms, search" hx-target="#usergroup-search-results" hx-indicator="#htmx-indicator-loading" />
                        <!-- Hidden input field for usergroup ID -->
                        <input id="usergroupId" type="hidden" name="usergroupId" form="userForm" />
                        <div class="dropdown-content" id="usergroup-search-results"></div>
                    </div>
                {% endif %}
                <form id="userForm" action="{{ request.get_full_path }}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- Include the hidden fields -->
                    {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}
                    <!-- Include the visible fields -->
                    {% for field in form.visible_fields %}
                        {% if field.widget_type == 'checkbox' %}
                            <div class="mb-3 form-switch">
                                {{ field }}
                                <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}{{ field.label_suffix }}</label>
                                {% if field.help_text %}
                                    <small id="{{ field.html_name }}Help" class="form-text text-muted">{{ field.help_text|safe }}</small>
                                {% endif %}
                                {% if field.errors %}
                                    <small class="text-danger">{{ field.errors }}</small>
                                {% endif %}
                                {% if field.name == 'street' %}
                                    <div class="form-text">
                                        <a class="card-link" href="https://www.google.com/maps/place/{{ user_address.formatted_address|urlencode }}" target="_blank">{{ user_address.formatted_address }}</a>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}{{ field.label_suffix }}</label>
                                {{ field }}
                                {% if field.help_text %}
                                    <small id="{{ field.html_name }}Help" class="form-text text-muted">{{ field.help_text|safe }}</small>
                                {% endif %}
                                {% if field.errors %}
                                    <small class="text-danger">{{ field.errors }}</small>
                                {% endif %}
                                {% if field.name == 'street' %}
                                    <div class="form-text">
                                        <a class="card-link" href="https://www.google.com/maps/place/{{ user_address.formatted_address|urlencode }}" target="_blank">{{ user_address.formatted_address }}</a>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                    <div class="d-flex flex-row-reverse">
                        <button class="btn btn-primary mt-2" type="submit" name="form_submit" id="form_submit">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
