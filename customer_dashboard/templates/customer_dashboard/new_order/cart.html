{% extends 'customer_dashboard/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
    Cart
{% endblock %}
{% block stylesheet %}
    <style>
        .htmx-swapping {
            opacity: 0;
            transition: opacity 1s ease-out;
        }
    </style>
{% endblock %}
{% block javascript %}
    <script>
        let allButtons = document.querySelectorAll(".button-remove-item");
        function removeItemFromCart(el) {
            // Get current query params.
            let queryParams = new URLSearchParams(window.location.search);
            // Get id of item
            let id = el.getAttribute("data-id");
            queryParams.set("id", encodeURIComponent(id));
            // Get cart-subtotal
            let cartSubtotal = document.getElementById("cart-subtotal");
            let subtotal = parseFloat(cartSubtotal.getAttribute("data-subtotal"));
            // let subtotal = parseFloat(cartSubtotal.innerText.replace("$", "").replace(",", ""));
            queryParams.set("subtotal", encodeURIComponent(subtotal));
            // get price of item
            let price = parseFloat(el.getAttribute("data-price"));
            queryParams.set("price", encodeURIComponent(price));
            // queryParams.set("price", encodeURIComponent(el.previousElementSibling.innerText.replace("$", "").replace(",", "")));
            // get count of items in address group
            let groupcountId = el.getAttribute("data-countid");
            let addressOrderCountEl = document.getElementById(groupcountId);
            let addressOrderCount = parseInt(addressOrderCountEl.getAttribute("data-count"));
            queryParams.set("groupcount", encodeURIComponent(addressOrderCount));
            // Get current number of cart-item elements
            let cartItems = document.querySelectorAll(".cart-item");
            queryParams.set("count", encodeURIComponent(cartItems.length));
            // Create url for removing item
            const removeItemUrl = "{% url 'customer_new_order_5' %}?" + queryParams.toString();
            // Get if of button for htmx
            let buttonId = el.getAttribute("id");
        
            // update hx-get attribute of date filter and tab urls
            htmx.find(`#${buttonId}`).setAttribute("hx-delete", removeItemUrl);
            // hx-delete="{% url 'customer_new_order_5' %}?id={{ item.order_group.id }}&subtotal={{ subtotal }}&price={{ item.price }}"
            // force htmx to process the new hx-get attributes
            htmx.process(`#${buttonId}`);
            // trigger onRemoveClick event
            htmx.trigger(el, "onRemoveClick");
        }
        // Add click event listener to all buttons
        {% comment %} allButtons.forEach(function (button) {
            button.addEventListener("click", function () {
                removeItemFromCart(this);
            });
        }); {% endcomment %}
        // Listen for page load and set the form field values to the query params
        document.addEventListener("DOMContentLoaded", function () {
            // Check if query params has filter
            const urlParams = new URLSearchParams(window.location.search);
            const filter = urlParams.get("filter");
            if (filter) {
                // update filter value
                document.getElementById("filterGroupSelect").value = filter;
            }
            // Check if query params has my_carts
            const myCarts = urlParams.get("my_carts");
            if (myCarts) {
                // update my_carts value
                document.getElementById("myCartsCheck").checked = true;
            }
            // Check if query params has start_date
            const startDate = urlParams.get("start_date");
            if (startDate) {
                // update start_date value
                document.getElementById("cartStartDate").value = startDate;
            }
            // Check if query params has end_date
            const endDate = urlParams.get("end_date");
            if (endDate) {
                // update end_date value
                document.getElementById("cartEndDate").value = endDate;
            }
        });
    </script>
{% endblock %}
{% block content %}
    <div class="container-fluid mb-2" hx-disabled-elt=".status-card, button, .form-control, .pagi-link">
        {% if request.user.is_staff %}
            <div class="row">
                <div class="col">
                    <div class="container-lg mb-4 border border-primary-subtle rounded-3 pt-4 pb-4">
                        <form class="row g-3" action="{% url 'customer_locations' %}" method="get" hx-get="{% url 'customer_cart' %}" hx-target="#cart-results" hx-swap="outerHTML" hx-push-url="true" hx-indicator="#htmx-indicator-loading-status">
                            <div class="col-10 mb-3">
                                <div class="input-group">
                                    <label class="input-group-text" for="filterGroupSelect">Options</label>
                                    <select class="form-select" id="filterGroupSelect" name="filter" aria-label="Filter Data By">
                                        <option value="new" selected>Created Today</option>
                                        <option value="starting">Starting in less than 5 days</option>
                                        <option value="inactive">Inactive for 5+ Days</option>
                                        <option value="expired">Expired</option>
                                        <option value="active">All Open Carts</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="myCartsCheck" name="my_carts" />
                                    <label class="form-check-label" for="myCartsCheck">My Carts</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="cartStartDate">Start Date Range</label>
                                <input id="cartStartDate" class="form-control" type="date" name="start_date" />
                            </div>
                            <div class="col-md-6">
                                <label for="cartEndDate">End Date Range</label>
                                <input id="cartEndDate" class="form-control" type="date" name="end_date" />
                            </div>

                            <div class="col-12">
                                <button type="submit" class="btn btn-primary float-end">Filter <span class="htmx-indicator" id="htmx-indicator-loading-status"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endif %}
        <div class="card shadow">
            <div class="card-header py-3">
                <div class="row">
                    <h3 id="cart-title" class="text-dark mb-1" data-cart-count="{{ cart_count }}">
                        Shopping Cart ({{ cart_count }}){% if help_text %}
                            - {{ help_text }}
                        {% endif %}
                    </h3>
                    <span class="htmx-indicator" id="htmx-indicator-loading-status"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
                </div>
            </div>
            <div class="card-body">
                <div class="accordion" role="tablist" id="cart-results" hx-get="{{ cart_link }}" hx-trigger="load" hx-swap="outerHTML" hx-indicator="#htmx-indicator-loading-status"></div>
            </div>
            <div class="card-footer">
                <h4 id="cart-subtotal" class="float-end mt-2" data-subtotal="{{ subtotal }}"><strong>Subtotal: ${{ subtotal|floatformat:2|intcomma }}</strong></h4>
            </div>
        </div>
    </div>
    <div class="container-fluid mb-1"></div>
{% endblock %}
{% block modals %}
    <div class="modal fade" role="dialog" tabindex="-1" id="modal-remove-item">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Are you sure?</h4>
                    <button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This will delete the Order from your Cart.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light" type="button" data-bs-dismiss="modal">Close</button>
                    {% comment %} <a class="btn btn-danger" type="button" name="action_button" href="{% url 'customer_new_order_6_remove' order_group_id=order_group.id %}">Delete</a> {% endcomment %}
                    {% comment %} <button class="btn btn-danger" type="button" name="action_button" onclick="removeItem()">Delete</button> {% endcomment %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}
