{% extends 'customer_dashboard/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
  Cart
{% endblock %}
{% block stylesheet %}
  <style>
    .htmx-swapping {
      opacity: 0;
      transition: opacity 1s ease-out;
    }
  </style>
{% endblock %}
{% block javascript %}
  <script>
        let allButtons = document.querySelectorAll(".button-remove-item");
        function removeItemFromCart(el) {
            // Get current query params.
            let queryParams = new URLSearchParams(window.location.search);
            // Get order group id of item
            let id = el.getAttribute("data-id");
            queryParams.set("id", encodeURIComponent(id));
            // Get order id
            let orderId = el.getAttribute("data-orderid");
            queryParams.set("order_id", encodeURIComponent(orderId));
            // Get cart-subtotal
            let cartSubtotal = document.getElementById("cart-subtotal");
            let subtotal = parseFloat(cartSubtotal.getAttribute("data-subtotal"));
            // let subtotal = parseFloat(cartSubtotal.innerText.replace("$", "").replace(",", ""));
            queryParams.set("subtotal", encodeURIComponent(subtotal));
            // get price of item
            let price = parseFloat(el.getAttribute("data-price"));
            queryParams.set("price", encodeURIComponent(price));
            // queryParams.set("price", encodeURIComponent(el.previousElementSibling.innerText.replace("$", "").replace(",", "")));
            // get count of items in address group
            let groupcountId = el.getAttribute("data-countid");
            let addressOrderCountEl = document.getElementById(groupcountId);
            let addressOrderCount = parseInt(addressOrderCountEl.getAttribute("data-count"));
            queryParams.set("groupcount", encodeURIComponent(addressOrderCount));
            // Get current number of cart-item elements
            let cartItems = document.querySelectorAll(".cart-item");
            queryParams.set("count", encodeURIComponent(cartItems.length));
            // Create url for removing item
            const removeItemUrl = "{% url 'customer_cart' %}?" + queryParams.toString();
            // Get if of button for htmx
            let buttonId = el.getAttribute("id");
        
            // update hx-get attribute of date filter and tab urls
            htmx.find(`#${buttonId}`).setAttribute("hx-delete", removeItemUrl);
            // hx-delete="{% url 'customer_cart' %}?id={{ item.order_group.id }}&subtotal={{ subtotal }}&price={{ item.price }}"
            // force htmx to process the new hx-get attributes
            htmx.process(`#${buttonId}`);
            // trigger onRemoveClick event
            htmx.trigger(el, "onRemoveClick");
        }
        // Add click event listener to all buttons
        {% comment %} allButtons.forEach(function (button) {
            button.addEventListener("click", function () {
                removeItemFromCart(this);
            });
        }); {% endcomment %}
        // Listen for page load and set the form field values to the query params
        document.addEventListener("DOMContentLoaded", function () {
            // Check if query params has filter
            const urlParams = new URLSearchParams(window.location.search);
            const filter = urlParams.get("filter");
            if (filter) {
                // update filter value
                document.getElementById("filterGroupSelect").value = filter;
            }
            // Check if query params has my_carts
            const myCarts = urlParams.get("my_carts");
            if (myCarts) {
                // update my_carts value
                document.getElementById("myCartsCheck").checked = true;
            }
            // Check if query params has start_date
            const startDate = urlParams.get("start_date");
            if (startDate) {
                // update start_date value
                document.getElementById("cartStartDate").value = startDate;
            }
            // Check if query params has end_date
            const endDate = urlParams.get("end_date");
            if (endDate) {
                // update end_date value
                document.getElementById("cartEndDate").value = endDate;
            }
        });

        function isValidEmail(email) {
            // Regular expression to validate email addresses
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function verifyCommaSeparatedEmails(value) {
            // Split the string by commas
            const emails = value.split(',');
        
            // Trim whitespace and validate each email
            for (let email of emails) {
                email = email.trim();
                if (email && !isValidEmail(email)) {
                    return false;
                }
            }
        
            return true;
        }
        let isSendingQuote = false;

        function showSendQuoteModal(customer_email, cart_order_ids) {
            {% comment %} let modal = new bootstrap.Modal(document.getElementById("modal-send-quote"), {
                keyboard: false,
                backdrop: "static"
            });
            modal.show(); {% endcomment %}
            console.log("showSendQuoteModal", customer_email, cart_order_ids);
            {% if request.user.is_staff and not is_impersonating %}
                let inputValue = `{{ request.user.email }}`;
                if (customer_email && customer_email !== "{{ request.user.email }}") {
                    inputValue += `, ${customer_email}`;
                }
            {% else %}
                let inputValue = `{{ request.user.email }}`;
                if ("{{ user.email }}" !== "{{ request.user.email }}") {
                    inputValue += `, {{ user.email }}`;
                }
                if (customer_email && customer_email !== "{{ request.user.email }}" && customer_email !== "{{ user.email }}") {
                    inputValue += `, ${customer_email}`;
                }
            {% endif %}
            Swal.fire({
                title: "Send Quote",
                footer: 'The reply to email address will be set to the email address of the user who sent the quote [{{request.user.email}}].',
                input: "textarea",
                inputLabel: "Comma separated list of email addresses to send the quote to.",
                inputValue,
                inputPlaceholder: "Comma separated list of email addresses to send the quote to.",
                inputAttributes: {
                  "aria-label": "Comma separated list of email addresses to send the quote to.",
                  "autocapitalize": "off",
                  "autocorrect": "off"
                },
                showCancelButton: true,
                showCloseButton: true,
                confirmButtonText: "Send it",
                cancelButtonText: "Cancel",
                showLoaderOnConfirm: true,
                inputValidator: (value) => {
                    return new Promise((resolve) => {
                      // Verify that value is a string of comma separated email addresses
                      if (verifyCommaSeparatedEmails(value)) {
                        resolve();
                      } else {
                        resolve("Please enter a valid comma separated list of email addresses.");
                      }
                    });
                  },
                preConfirm: async (login) => {
                    isSendingQuote = true;
                    try {
                        // POST request to send quote, send email to all email addresses
                        // Pass in list of email addresses and list cart_order_ids into post body
                        const response = await fetch("{% url 'customer_cart_send_quote' %}", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}"
                            },
                            body: JSON.stringify({
                                emails: login.split(",").map((email) => email.trim()),
                                ids: cart_order_ids
                            })
                        });
                        isSendingQuote = false;
                        if (!response.ok) {
                            return Swal.showValidationMessage(`
                            ${JSON.stringify(await response.json())}
                            `);
                        }
                        return response.json();
                    } catch (error) {
                        isSendingQuote = false;
                        Swal.showValidationMessage(`
                            Request failed: ${error}
                        `);
                    }
                  },
                  allowOutsideClick: () => {
                    return !Swal.isLoading() && !isSendingQuote;
                  }
              }).then((result) => {
                console.log("result", result);
                if (result.isConfirmed) {
                    // Swal.fire(result.value);
                    if (result.value) {
                        if (result.value.error) {
                            Swal.fire({
                                title: "Error",
                                text: result.value.error,
                                icon: "error"
                            });
                        } else {
                            Swal.fire({
                                title: "Success",
                                text: result.value.message,
                                icon: "success"
                            }).then(() => {
                                // Reload the page
                                location.reload();
                            });
                        }
                    }
                }
              });
        }
    </script>
{% endblock %}
{% block content %}
  <div class="container-fluid mb-2" hx-disabled-elt=".status-card, button, .form-control, .pagi-link">
    {% if request.user.is_staff %}
      <div class="row">
        <div class="col">
          <div class="container-lg mb-4 border border-primary-subtle rounded-3 pt-4 pb-4">
            <form class="row g-3" action="{% url 'customer_locations' %}" method="get" hx-get="{% url 'customer_cart' %}" hx-target="#cart-results" hx-swap="outerHTML" hx-push-url="true" hx-indicator="#htmx-indicator-loading-status">
              <div class="col-10 mb-3">
                <div class="input-group">
                  <label class="input-group-text" for="filterGroupSelect">Options</label>
                  <select class="form-select" id="filterGroupSelect" name="filter" aria-label="Filter Data By">
                    <option value="new">Created Today</option>
                    <option value="starting">Expiring in 5 days</option>
                    <option value="inactive">Inactive for 5+ Days</option>
                    <option value="expired">Expired</option>
                    <option value="active" selected>All Open Orders</option>
                  </select>
                </div>
              </div>
              <div class="col-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="myCartsCheck" name="my_carts" />
                  <label class="form-check-label" for="myCartsCheck">My Orders</label>
                </div>
              </div>
              <div class="col-md-6">
                <label for="cartStartDate">Start Date Range</label>
                <input id="cartStartDate" class="form-control" type="date" name="start_date" />
              </div>
              <div class="col-md-6">
                <label for="cartEndDate">End Date Range</label>
                <input id="cartEndDate" class="form-control" type="date" name="end_date" />
              </div>

              <div class="col-12">
                <button type="submit" class="btn btn-primary float-end">Filter <span class="htmx-indicator" id="htmx-indicator-loading-status"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span></button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}
    <div class="card shadow">
      <div class="card-header py-3">
        <div class="row">
          <h3 id="cart-title" class="text-dark mb-1" data-cart-count="{{ cart_count }}">
            Shopping Cart ({{ cart_count }}){% if help_text %}
              - {{ help_text }}
            {% endif %}
          </h3>
          <span class="htmx-indicator" id="htmx-indicator-loading-status"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
        </div>
      </div>
      <div class="card-body">
        <div class="accordion" role="tablist" id="cart-results" hx-get="{{ cart_link }}" hx-trigger="load" hx-swap="outerHTML" hx-indicator="#htmx-indicator-loading-status"></div>
      </div>
      <div class="card-footer">
        <h4 id="cart-subtotal" class="float-end mt-2" data-subtotal="{{ subtotal }}"><strong>Subtotal: ${{ subtotal|floatformat:2|intcomma }}</strong></h4>
      </div>
    </div>
  </div>
  <div class="container-fluid mb-1"></div>
{% endblock %}
