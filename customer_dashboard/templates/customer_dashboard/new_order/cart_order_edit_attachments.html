{% load static %}
{% block javascript %}
    <script>
        function loadAttachmentsFormset() {
            const addAttachmentButton = document.getElementById("add-attachments");
            const formsetDiv = document.getElementById("attachments-formset");
            const totalForms = document.getElementById("id_attachments-TOTAL_FORMS");
            const emptyFormTemplate = document.getElementById("attachments-empty").innerHTML;
        
            const attachmentForms = document.querySelectorAll(".attachments-form");
            attachmentForms.forEach(function (form) {
                const deleteInput = form.querySelector('input[type="hidden"][id$="-DELETE"]');
                if (deleteInput && deleteInput.value === "on") {
                    form.style.display = "none";
                }
            });
        
            addAttachmentButton.addEventListener("click", function () {
                const currentFormCount = parseInt(totalForms.value);
                const newFormCount = currentFormCount + 1;
                const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, currentFormCount);
        
                formsetDiv.insertAdjacentHTML("beforeend", newFormHtml);
                totalForms.value = newFormCount;
                const emptyText = document.querySelectorAll(".empty-text");
                emptyText.forEach(function (text) {
                    text.style.display = "none";
                });
            });
        }
        document.body.addEventListener("htmx:afterRequest", function (evt) {
            if (evt.detail.target.id.startsWith("edit-attachments-modal")) {
                loadAttachmentsFormset();
            }
        });
    </script>
{% endblock %}
<div class="modal-dialog modal-dialog-centered">
    <div id="htmx-indicator-loading-card" class="htmx-indicator htmx-indicator-card modal-content">
        <div class="modal-body d-flex justify-content-center align-items-center p-3" style="min-height: 500px;">
            <div class="spinner-border text-primary m-3" role="status"></div>
        </div>
    </div>
    <div class="modal-content htmx-loading-hide">
        <!-- prettier-ignore -->
        <form id="form-card-edit" 
          data-order-group-id="{{ order_group.id|default:'new' }}"
          method="post" 
          hx-post="{% url 'customer_order_group_edit_attachments' order_group.id %}" 
          hx-indicator="#htmx-indicator-save-btn" 
          hx-disabled-elt="button, .form-control, .form-select"
          hx-swap="outerHTML"
          hx-target="#edit-attachments-modal">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Add Attachments</h5>
        <button type="button" class="btn btn-success" id="add-attachments"><i class="fas fa-plus fa-sm text-white"></i></button>
      </div>
      <div class="modal-body">
        <!-- Form -->
        <div class="overflow-auto">{{ attachments_formset.as_table }}</div>
        <hr>
        <!--  End Form -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success" name="edit_card">
          Save
          <span id="htmx-indicator-save-btn" class="htmx-indicator"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
        </button>
      </div>
    </form>
    </div>
</div>
