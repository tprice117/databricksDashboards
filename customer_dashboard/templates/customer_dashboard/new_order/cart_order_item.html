{% load static %}
{% load tz %}
{% load humanize %}
{% block stylesheet %}
  <style>
    .subtitle {
        font-family: 'Outfit';
        font-style: normal;
        font-weight: 700;
        font-size: 18px;
        line-height: 24px;
        color: #0F1B22;
    }
    .order-descriptor {
        font-family: 'Outfit';
        font-style: normal;
        font-weight: 700;
        font-size: 14px;
        line-height: 16px;
        color: #0F1B22;
    }
  </style>
{% endblock %}
<div class="row cart-item mb-2">
    <div class="col">
        <div class="card" style="background: var(--bs-card-cap-bg);">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="row cart-body">
                            {% with order=item.order %}
                            <div class="col-auto">
                                {% with main_product=item.main_product %}
                                <img class="img-thumbnail img-fluid"
                                    alt="Product image"
                                    width="138"
                                    height="95"
                                    src="{% if main_product.images.first %}
                                        {{ main_product.images.first.image.url }}
                                    {% elif main_product.main_product_category.icon %}
                                        {{ main_product.main_product_category.icon.url }}
                                    {% else %}
                                        {% static 'customer_dashboard/img/logo.png' %}
                                    {% endif %}" />
                                {% endwith %}
                            </div>
                            <div class="col" id="details-{{loopcount}}">
                                <h3 class="subtitle">{{ item.main_product.name }}</h3>
                                <p class="mb-1 order-descriptor">Service date: <span class="fw-light">{{ order.end_date }}</span>
                                    {% if not form %}
                                    <button class="btn btn-link edit-start-date ps-2 p-0" id="btn-{{loopcount}}" type="button" hx-post="{% url 'customer_cart_date_edit' order_id=order.id %}" hx-vals='{"loopcount": "{{loopcount}}"}' hx-target="closest .cart-item" hx-swap="outerHTML" hx-indicator="#htmx-indicator-edit-date-{{loopcount}}">
                                        <i class="fas fa-edit" style="color: #007bff;" id="edit-start-date-icon-{{loopcount}}"></i>
                                        <span class="htmx-indicator" id="htmx-indicator-edit-date-{{loopcount}}"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
                                    </button>
                                    {% endif %}
                                </p>
                                <div id="changeDateForm-{{loopcount}}">
                                    {% if form %}
                                    <div class="row">
                                        <div class="col-auto">
                                            <div class="card">
                                                <div class="card-body">
                                                    <form hx-post="{% url 'customer_cart_date_edit' order_id=order.id %}" hx-vals='{"loopcount": "{{loopcount}}", "save": true}' hx-target="closest .cart-item" hx-swap="outerHTML" hx-indicator="#htmx-indicator-date-save-{{loopcount}}">
                                                        {% csrf_token %}
                                                        {% for field in form.visible_fields %}
                                                        {% if field.widget_type == 'checkbox' %}
                                                        <div class="mb-3 form-switch">
                                                            {{ field }}
                                                            <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}{{ field.label_suffix }}</label>
                                                            {% if field.help_text %}
                                                            <small id="{{ field.html_name }}Help" class="form-text text-muted">{{ field.help_text|safe }}</small>
                                                            {% endif %}
                                                            {% if field.errors %}
                                                            <small class="text-danger">{{ field.errors }}</small>
                                                            {% endif %}
                                                        </div>
                                                        {% else %}
                                                        <div class="mb-3">
                                                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}{{ field.label_suffix }}</label>
                                                            {{ field }}
                                                            {% if field.help_text %}
                                                            <small id="{{ field.html_name }}Help" class="form-text text-muted">{{ field.help_text|safe }}</small>
                                                            {% endif %}
                                                            {% if field.errors %}
                                                            <small class="text-danger">{{ field.errors }}</small>
                                                            {% endif %}
                                                            {% if field.name == 'street' %}
                                                            <div class="form-text">
                                                                <a class="card-link" href="https://www.google.com/maps/place/{{ user_address.formatted_address|urlencode }}" target="_blank">{{ user_address.formatted_address }}</a>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                        {% endfor %}
                                                        <div class="d-flex flex-row-reverse">
                                                            <button class="btn btn-primary" type="submit" name="save_start_button" style="margin-top: 12px;">
                                                                Save
                                                                <span class="htmx-indicator" id="htmx-indicator-date-save-{{loopcount}}"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
                                                            </button>
                                                            <button class="btn btn-secondary" type="button" name="cancel_start_button" style="margin-top: 12px; margin-right: 10px;" hx-post="{% url 'customer_cart_date_edit' order_id=order.id %}" hx-vals='{"loopcount": "{{loopcount}}", "cancel": true}' hx-vals='{"loopcount": "{{loopcount}}"}' hx-target="closest .cart-item" hx-swap="outerHTML" hx-indicator="#htmx-indicator-date-cancel-{{loopcount}}" hx-trigger="click">
                                                                Cancel
                                                                <span class="htmx-indicator" id="htmx-indicator-date-cancel-{{loopcount}}"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <p class="mb-1 order-descriptor">Order type: <span class="fw-light">{{ order.order_type }}</span></p>
                                {% include 'customer_dashboard/snippets/cart_order_item_po.html' with order_group=order.order_group %}
                                {% if request.user.is_staff %}
                                <p class="mb-1 order-descriptor">Created by: <span class="fw-light">{% if order.created_by %}{{ order.created_by.full_name }}{% else %}N/A{% endif%} on {{ order.created_on|timezone:"America/Chicago" }} (CT)</span></p>
                                {% endif %}
                            </div>
                            <div class="col-auto">
                                <p class="text-end mb-1">Subtotal: ${{ item.subtotal|floatformat:2|intcomma }}</p>
                                <p class="text-end mb-1">Estimated Taxes: ${{ item.tax|floatformat:2|intcomma }}</p>
                                <p class="text-end">Total: ${{ item.total|floatformat:2|intcomma }}</p>
                            </div>
                            <div class="col-auto">
                                <div class="row justify-content-center">
                                    <div class="col-auto">
                                        <button class="btn btn-outline-danger button-remove-item" id="button-remove-item_{{ order.order_group.id }}" type="button"
                                        data-id="{{ order.order_group.id }}" data-orderid="{{ order.id }}" data-price="{{ item.total }}" data-countid="count-{{ cart_address.address.id }}"
                                        hx-target="closest .cart-item" hx-trigger="onRemoveClick" hx-swap="outerHTML swap:1s"
                                        onClick="event.stopPropagation();
                                        Swal.fire(
                                            {title: 'Are you sure?', text:'This will delete the Order from your Cart.', icon: 'question', confirmButtonText: 'Delete'}
                                            ).then((result)=>{
                                                if(result.isConfirmed){removeItemFromCart(this);}
                                                })">
                                                Remove
                                                <span class="htmx-indicator" id="htmx-indicator-status"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>
                                            </button>
                                        </div>
                                    </div>
                                    {% if request.user.is_superuser %}
                                    <div class="row justify-content-center">
                                        <div class="col-auto">
                                            <a class="btn btn-link" role="button" href="/admin/api/order/{{order.id}}/change/">In database</a>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if request.user.is_staff %}
                                    {% if not order.order_group.is_agreement_signed %}
                                    {% if order.order_group.agreement %}
                                    <a class="btn btn-sm btn-danger" href="{{ order.order_group.agreement.url }}" target="_blank" download><i class="far fa-file-pdf"></i>&nbsp; Agreement</a>
                                    {% endif %}
                                    {% elif order.requires_terms_agreement %}
                                    <a class="btn btn-sm btn-success" href="{{ order.order_group.agreement.url }}" target="_blank" download><i class="far fa-file-pdf"></i>&nbsp; Agreement</a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                <script>
                                    var should_reload = {{ reload|yesno:"true,false" }};
                                    document.body.addEventListener("htmx:afterSettle", function (event){
                                        if ( should_reload ) {
                                            setTimeout(function(){
                                                location.reload();
                                            }, 20);
                                        }
                                    });
                                </script>
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>