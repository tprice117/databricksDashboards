{% extends 'customer_dashboard/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
  Select Options
{% endblock %}
{% block stylesheet %}
  <style></style>
{% endblock %}
{% block javascript %}
  <script>
    // Autocomplete for Customer/UserGroup search
    // Helped by: https://www.w3schools.com/howto/howto_js_autocomplete.asp
    var currentFocus
    let usergroupInput = document.getElementById('user_address-search')
    
    function removeAutocompleteDropdown() {
      let dropdownItems = document.querySelectorAll('.my-dropdown-item')
      dropdownItems.forEach(function (item) {
        item.remove()
      })
    }
    function addActive(x) {
      /*a function to classify an item as "active":*/
      if (!x) return false
      /*start by removing the "active" class on all items:*/
      removeActive(x)
      if (currentFocus >= x.length) currentFocus = 0
      if (currentFocus < 0) currentFocus = x.length - 1
      /*add class "autocomplete-active":*/
      x[currentFocus].classList.add('autocomplete-active')
    }
    function removeActive(x) {
      /*a function to remove the "active" class from all autocomplete items:*/
      for (var i = 0; i < x.length; i++) {
        x[i].classList.remove('autocomplete-active')
      }
    }
    /*execute a function when someone clicks in the document:*/
    document.addEventListener('click', function (e) {
      if (e.target != usergroupInput) {
        removeAutocompleteDropdown()
      }
    })
    function addUsergroupAutocompleteListeners() {
      currentFocus = -1
      let dropdownItems = document.querySelectorAll('.my-dropdown-item')
      dropdownItems.forEach(function (item) {
        item.addEventListener('click', function () {
          // Update the display field with the user_address's name
          document.getElementById('user_address-search').value = item.getAttribute('data-name')
          // Update the hidden field with the user_address's ID
          document.getElementById('id_user_address').value = item.getAttribute('data-id')
          removeAutocompleteDropdown()
        })
      })
    }
    function initUsergroupAutocomplete(user_addresses) {
      usergroupInput = document.getElementById('user_address-search')
      // If the usergroupInput is not found, return
      if (!usergroupInput) return
      usergroupInput.addEventListener('keydown', function (e) {
        var x = document.getElementById('user_address-search-results')
        if (x) x = x.getElementsByTagName('div')
        if (x) {
          if (e.keyCode == 40) {
            /*If the arrow DOWN key is pressed, increase the currentFocus variable:*/
            currentFocus++
            /*and and make the current item more visible:*/
            addActive(x)
          } else if (e.keyCode == 38) {
            /*If the arrow UP key is pressed, decrease the currentFocus variable:*/
            currentFocus--
            /*and and make the current item more visible:*/
            addActive(x)
          } else if (e.keyCode == 13) {
            /*If the ENTER key is pressed, prevent the form from being submitted,*/
            e.preventDefault()
            if (currentFocus > -1) {
              /*and simulate a click on the "active" item:*/
              if (x) x[currentFocus].click()
            }
          }
        }
      })
    }
    
    // listen for page load event.
    document.addEventListener('DOMContentLoaded', function () {
      initUsergroupAutocomplete()
      addUsergroupAutocompleteListeners()
    })
    // listen for htmx afterSettle event.
    document.body.addEventListener('htmx:afterSettle', function (event) {
      addUsergroupAutocompleteListeners()
    })
  </script>
{% endblock %}
{% block content %}
  <div class="container-xxl">
    <h6 class="pb-3 mb-3">
      {% if main_product.main_product_category.group %}
        {{ main_product.main_product_category.group }} /
      {% endif %}{{ main_product.main_product_category }} / <span class="text-primary">{{ main_product.name }}</span>
    </h6>
    <div class="row row-cols-1 row-cols-sm-1 row-cols-md-2">
      <div class="col col-xl-5 px-4">
        {% with images=main_product.images.all %}
          <!-- Image Carousel -->
          <div id="imageCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              {% for main_product_image in images %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                  <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                    <img class="d-block w-100 h-100 object-fit-contain" style="border-radius: 37px;" src="{{ main_product_image.image.url }}" alt="Slide {{ forloop.counter0 }}" />
                  </div>
                </div>
              {% empty %}
                <div class="carousel-item active">
                  <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                    <img class="d-block w-100 h-100"
                      style="border-radius: 37px;"
                      src="{% if main_product.image_del %}
                        {{ main_product.image_del }}
                      {% elif main_product.main_product_category.icon %}
                        {{ main_product.main_product_category.icon.url }}
                      {% else %}
                        {% static 'customer_dashboard/img/logo.png' %}
                      {% endif %}"
                      alt="Slide 0" />
                  </div>
                </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
            <div class="carousel-indicators mt-1">
              {% for main_product_image in images %}
                <button type="button" class="{% if forloop.first %}active{% endif %}" data-bs-target="#imageCarousel" data-bs-slide-to="{{ forloop.counter0 }}" aria-label="Slide {{ forloop.counter0 }}"><img class="d-block w-100" src="{{ main_product_image.image.url }}" /></button>
              {% empty %}
                <button type="button" class="active" data-bs-target="#imageCarousel" data-bs-slide-to="0" aria-label="Slide 0">
                  <img class="d-block w-100"
                    src="{% if main_product.image_del %}
                      {{ main_product.image_del }}
                    {% elif main_product.main_product_category.icon %}
                      {{ main_product.main_product_category.icon.url }}
                    {% else %}
                      {% static 'customer_dashboard/img/logo.png' %}
                    {% endif %}" />
                </button>
              {% endfor %}
            </div>
          </div>
        {% endwith %}
        <!-- Product Infos -->
        {% with infos=main_product.mainproductinfo_set.all %}
          <div class="card mb-3">
            <div class="card-header bg-secondary p-3" aria-expanded="true" data-bs-toggle="collapse" data-bs-target="#rentalCardBody" aria-controls="rentalCardBody" type="button">
              <h6 class="text-white m-0">Product Information</h6>
            </div>
            <div id="rentalCardBody" class="card-body collapse show">
              {% for info in infos %}
                <div class="mb-3">
                  <p class="text-dark m-0">
                    <strong>{{ info.name }}</strong>
                  </p>
                  <p class="m-0">{{ info.description }}</p>
                </div>
              {% empty %}
                <p class="text-muted m-0">{{ main_product.description|default:'No information available.' }}</p>
              {% endfor %}
            </div>
          </div>
        {% endwith %}
      </div>
      <div class="col col-xl-7 mb-4 px-4">
        <h2 class="text-dark"><strong>{{ main_product.name }}</strong></h2>
        <p class="text-muted mb-2">
          {% with listings_count=main_product.listings_count %}
            {{ listings_count }} listing{{ listings_count|pluralize }}
          {% endwith %}&nbsp;|&nbsp; <i class="far fa-thumbs-up me-2"></i>{{ main_product.likes_count|intcomma }}
        </p>
        <hr style="border-color: var(--bs-dark); opacity: 0.75;" />
        <form action="{% url 'customer_new_order_3' product_id=product_id %}" method="post" class="mb-2" enctype="multipart/form-data">
          {% csrf_token %}
          <!-- Include the hidden fields -->
          {% for hidden in form.hidden_fields %}
            {{ hidden }}
          {% endfor %}
          <!-- Include the visible fields -->
          {% if user_addresses|length < 20 %}
            <label for="user_address" class="form-label mb-0"><strong class="text-dark"><i class="far fa-map-marker-alt me-2"></i>Select an Address</strong><a class="btn btn-primary btn-sm d-sm-inline-block ms-2 mb-1 px-3" role="button" href="{% url 'customer_new_location' %}?return_to={{ request.get_full_path }}">Create Now</a></label>
            <select class="form-select" name="user_address" style="margin-bottom: 12px;" required>
              <optgroup label="Your added locations">
                {% for user_address in user_addresses %}
                  {% if selected_user_address and selected_user_address.id == user_address.id %}
                    <option value="{{ user_address.id }}" selected>{{ user_address.name }} | {{ user_address.formatted_address }}</option>
                  {% else %}
                    <option value="{{ user_address.id }}">{{ user_address.name }} | {{ user_address.formatted_address }}</option>
                  {% endif %}
                {% endfor %}
              </optgroup>
            </select>
          {% else %}
            <div class="dropdown mb-3">
              <label for="user_address-search" class="form-label mb-0"><strong class="text-dark"><i class="far fa-map-marker-alt me-2"></i>Search Address</strong><a class="btn btn-primary btn-sm d-sm-inline-block ms-2 mb-1 px-3" role="button" href="{% url 'customer_new_location' %}">Create Now</a> <span class="htmx-indicator" id="htmx-indicator-loading2"><img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span></label>
              {% if selected_user_address %}
                <input id="user_address-search" class="form-control" autocomplete="off" type="search" name="q" required="true" value="{{ selected_user_address.name }}" hx-get="{% url 'customer_user_address_search' user_id=user.id %}" hx-trigger="input changed delay:500ms, search" hx-target="#user_address-search-results" hx-indicator="#htmx-indicator-loading2" />
                <!-- Hidden input field for user_address ID is added by forms.py with id=id_user_address -->
              {% else %}
                <input id="user_address-search" class="form-control" autocomplete="off" type="search" name="q" required="true" hx-get="{% url 'customer_user_address_search' %}" hx-trigger="input changed delay:500ms, search" hx-target="#user_address-search-results" hx-indicator="#htmx-indicator-loading2" />
                <!-- Hidden input field for user_address ID is added by forms.py id=id_user_address -->
              {% endif %}
              <div class="dropdown-content" id="user_address-search-results"></div>
            </div>
          {% endif %}
          {% for product_add_on in product_add_ons %}
            <p style="margin-bottom: 0px;">{{ product_add_on.add_on.name }}</p>
            <select class="form-select" name="product_add_on_choices" style="margin-bottom: 12px;">
              <optgroup label="{{ product_add_on.add_on.name }}">
                {% for product_add_on_choice in product_add_on.choices %}
                  <option value="{{ product_add_on_choice.id }}">{{ product_add_on_choice.name }}</option>
                {% endfor %}
              </optgroup>
            </select>
          {% endfor %}
          {% for field in form.visible_fields %}
            {% if field.widget_type == 'checkbox' %}
              <div class="mb-3 form-switch">
                {{ field }}
                <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}{{ field.label_suffix }}</label>
                {% if field.help_text %}
                  <small id="{{ field.html_name }}Help" class="form-text text-muted">{{ field.help_text|safe }}</small>
                {% endif %}
                {% if field.errors %}
                  <small class="text-danger">{{ field.errors }}</small>
                {% endif %}
              </div>
            {% else %}
              <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}{{ field.label_suffix }}</label>
                {{ field }}
                {% if field.help_text %}
                  <small id="{{ field.html_name }}Help" class="form-text text-muted">{{ field.help_text|safe }}</small>
                {% endif %}
                {% if field.errors %}
                  <small class="text-danger">{{ field.errors }}</small>
                {% endif %}
                {% if field.name == 'street' %}
                  <div class="form-text">
                    <a class="card-link" href="https://www.google.com/maps/place/{{ user_address.formatted_address|urlencode }}" target="_blank">{{ user_address.formatted_address }}</a>
                  </div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
          {% if form_error %}
            <hr />
            <p class="text-danger">{{ form_error }}</p>
          {% endif %}
          {% if form_msg %}
            <hr />
            <p class="text-success">{{ form_msg }}</p>
          {% endif %}
          <hr />
          <button class="btn btn-primary w-100 shadow" type="submit" name="action_button" id="submit-button"><small>Find a Supplier</small></button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
