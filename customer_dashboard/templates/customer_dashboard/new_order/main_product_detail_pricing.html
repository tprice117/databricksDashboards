{% extends 'customer_dashboard/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
    Select Supplier
{% endblock %}
{% block stylesheet %}
    <style></style>
{% endblock %}
{% block javascript %}
    <script>
        const discountElement = document.getElementById("discount");
        // create a function for updating the supplier list
        function updateSupplierList(is_pickup) {
            // Change the pricing modal One Time Charges
            let pricingModalOneTimeCharges = document.getElementById("price-detail-one-time-charges-card");
            if (pricingModalOneTimeCharges) {
                if (is_pickup) {
                    pricingModalOneTimeCharges.classList.add("d-none");
                } else {
                    pricingModalOneTimeCharges.classList.remove("d-none");
                }
            }
            // Get the parent element
            const parent = document.querySelector("#main-product-detail-pricing-list");
            if (!parent) return;
            // Convert the list items into an array
            const itemsArray = Array.from(parent.querySelectorAll(".supplier-item"));
            if (!itemsArray || itemsArray.length === 0) {
                // reverse button click
                document.getElementById("for-delivery-check").checked = false;
                document.getElementById("for-pickup-check").checked = false;
                // disable deliveryButton and pickupButton
                document.getElementById("for-delivery-check").disabled = true;
                document.getElementById("for-pickup-check").disabled = true;
                return;
            }
            // for a test show the item id in their respective elements
            for (let i = 0; i < itemsArray.length; i++) {
                // get data-seller-product-seller-location from the elements
                data_allow_pickup = itemsArray[i].getAttribute("data-allow-pickup");
                // if the checkbox is checked and the data-allow-pickup is false
                itemsArray[i].style.display = "";
                const isDeliveryInput = itemsArray[i].querySelector('input[name="is_delivery"]');
                // default to show the freit section
                const freitSection = itemsArray[i].querySelector('[id^="freit-section"]');
                freitSection.style.display = "";
                // the value passed back
                isDeliveryInput.setAttribute("value", "True");
                // show the total
                const displayPrice = itemsArray[i].querySelector("#display-price");
                const rawPrice = parseFloat(displayPrice.getAttribute("data-price-with-delivery"));
                // change the price attribute
                displayPrice.setAttribute("data-price",rawPrice)
                price = 0.00;
                if (rawPrice==NaN) {
                    price = 0.00
                } else if (discountElement) {
                    const discount = discountElement.value
                    price = rawPrice  * (1 - discount / 100)
                }
                const betterPrice = price.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                displayPrice.textContent = `$${betterPrice}`;
                // hide distance
                const distance = itemsArray[i].querySelector(".distance-element");
                distance.style.display = "none";
                if (is_pickup) {
                    // data_allow_pickup is false then remove the element
                    if (data_allow_pickup.toLowerCase() === "false") {
                        itemsArray[i].style.display = "none";
                    } else {
                        // show distance
                        distance.style.display = "";
                        // remove a child element with id starts with "freit-section-"
                        freitSection.style.display = "none";
                        // show the total without delivery
                        const rawPrice = parseFloat(displayPrice.getAttribute("data-price-with-delivery")) - parseFloat(displayPrice.getAttribute("data-delivery-price"));
                        // change the price attribute
                        displayPrice.setAttribute("data-price",rawPrice)
                        price = 0.00;
                        if (rawPrice==NaN) {
                            price = 0.00
                        } else if (discountElement) {
                            const discount = discountElement.value
                            price = rawPrice  * (1 - discount / 100)
                        }
                        const betterPrice = price.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        displayPrice.textContent = `$${betterPrice}`;
                        isDeliveryInput.setAttribute("value", "False");
                    }
                }
            }
        }
        const deliveryButton = document.getElementById("for-delivery-check");
        const pickupButton = document.getElementById("for-pickup-check");
        
        deliveryButton.addEventListener("change", () => {
            if (deliveryButton.checked) {
                // is_pickup is false
                updateSupplierList(false);
            }
        });
        pickupButton.addEventListener("change", () => {
            if (pickupButton.checked) {
                // is_pickup is true
                updateSupplierList(true);
            }
        });
        
        // Disable the form inputs while htmx request is being sent
        document.body.addEventListener("htmx:beforeSend", function (event) {
            document.getElementById("sort-btn").disabled = true;
            if (discountElement) {
                discountElement.disabled = true;
            }
        });
        // Enable the form inputs again after the swap
        document.body.addEventListener("htmx:afterSwap", function (event) {
            document.getElementById("sort-btn").disabled = false;
            if (discountElement) {
                discountElement.disabled = false;
            }
        });
        
        // listen for the range slider discount change event
        if (discountElement) {
            discountElement.addEventListener("input", function () {
                // get the value of the range slider
                let discount = this.value;
                // get all order-form-discount elements
                let orderFormDiscounts = document.querySelectorAll(".order-form-discount");
                // loop through all order-form-discount elements
                orderFormDiscounts.forEach(function (orderFormDiscount) {
                    // update the value of the order-form-discount element
                    orderFormDiscount.value = discount;
                });
                // get the discountLabel element
                let discountLabel = document.getElementById("discountLabel");
                // update the text of the discountLabel element
                discountLabel.innerText = discount + "%";
                // get all price-item elements
                let priceItems = document.querySelectorAll(".price-item");
                // loop through all price-item elements
                priceItems.forEach(function (priceItem) {
                    // get the price of the price-item element
                    let price = parseFloat(priceItem.getAttribute("data-price"));
                    // check if the price is NaN
                    if (isNaN(price)) {
                        return;
                    }
                    // calculate the new price
                    let newPrice = price * (1 - discount / 100);
                    // update the price of the price-item element
                    // check if innerText contained a dollar sign
                    if (priceItem.innerText.includes("$")) {
                        priceItem.innerText = "$" + newPrice.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, "$&,");
                    } else {
                        priceItem.innerText = newPrice.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, "$&,");
                    }
                });
            });
        }
        
        function onChatClick(event) {
            // open intercom chat. https://developers.intercom.com/installing-intercom/web/methods
            window.Intercom("showNewMessage");
        }
        
        function sortList() {
            // Get the parent element
            const parent = document.querySelector("#main-product-detail-pricing-list");
            if (!parent) return;
        
            // Convert the list items into an array
            const itemsArray = Array.from(parent.querySelectorAll(".supplier-item"));
        
            // Get the selected sort options
            const reverse = document.getElementById("sort-order").value == "desc";
            const attr = document.getElementById("sort-attribute").value;
        
            // Get the valueSelector (the value to sort the elements by)
            let valueSelector;
            switch (attr) {
                case "rating":
                    valueSelector = ".rating";
                    break;
                case "name":
                    valueSelector = ".supplier-name";
                    break;
                case "last_checkout":
                    valueSelector = ".last-checkout";
                    break;
                case "distance":
                    valueSelector = ".distance";
                    break;
                case "price":
                default:
                    valueSelector = ".total-price";
            }
        
            // Sort the array based on the value of the inner element
            itemsArray.sort((a, b) => {
                let aValue, bValue;
                if (attr == "last_checkout") {
                    aValue = new Date(a.querySelector(valueSelector).value);
                    bValue = new Date(b.querySelector(valueSelector).value);
                } else if (attr == "distance") {
                    aValue = parseFloat(a.querySelector(valueSelector).value);
                    bValue = parseFloat(b.querySelector(valueSelector).value);
                } else if (attr == "name") {
                    aValue = a.querySelector(valueSelector).innerText.trim().toLowerCase();
                    bValue = b.querySelector(valueSelector).innerText.trim().toLowerCase();
                } else {
                    aValue = parseFloat(a.querySelector(valueSelector).value);
                    bValue = parseFloat(b.querySelector(valueSelector).value);
                }
                if (aValue < bValue) return reverse ? 1 : -1;
                if (aValue > bValue) return reverse ? -1 : 1;
                return 0;
            });
        
            // Append the sorted elements back to the parent element
            itemsArray.forEach((item) => parent.appendChild(item));
        }
    </script>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <h3 class="text-dark mb-1">New Booking: Supplier Options</h3>
        <div class="row">
            <div class="col">
                {% if request.user.is_staff %}
                    <div class="container-sm pt-4 pb-4">
                        <label for="discount" class="form-label">Discount <b id="discountLabel">{{ discount }}%</b> (Marketplace Discount: {{ market_discount|floatformat }}%)</label>
                        <input form="orderForm" type="range" class="form-range" min="0" max="{{ max_discount_100 }}" step="0.5" id="discount" name="discount2" value="{{ discount }}" />
                    </div>
                {% endif %}

                <!-- Sorting Controls -->
                <div class="float-right justify-content-end mb-3 d-flex flex-row">
                    <div class="form-check form-switch d-flex flex-row form-group align-items-center w-50">
                        <input type="radio" class="btn-check" name="options-outlined" id="for-delivery-check" autocomplete="off" checked />
                        <label class="btn btn-outline-primary" for="for-delivery-check">For delivery</label>
                        <input type="radio" class="btn-check" name="options-outlined" id="for-pickup-check" autocomplete="off" />
                        <label class="btn btn-outline-primary" for="for-pickup-check">For pickup</label>

                        <input type="radio" class="btn-check d-none" name="options-outlined" id="is_delivery" autocomplete="off" />
                    </div>
                    <div id="sorting-controls" class="d-flex flex-row form-group align-items-center w-50">
                        <label for="sort-attribute" class="form-label mb-0 mr-2 text-nowrap">Sort by:</label>
                        <select id="sort-attribute" class="form-control mr-2" name="sort-attribute">
                            <option value="price">Total Price</option>
                            <option value="distance">Distance</option>
                            <option value="name">Location Name</option>
                            <option value="rating">Rating</option>
                            {% if request.user.is_staff %}
                                <option value="last_checkout">Last Checkout</option>
                            {% endif %}
                        </select>
                        <select id="sort-order" class="form-control mr-2" name="sort-order">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                        <button id="sort-btn" class="btn btn-outline-primary" onclick="sortList()">Go</button>
                    </div>
                </div>
                <span class="htmx-indicator" id="htmx-indicator-loading-status">Loading <img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>

                <div id="main-product-detail-pricing-list" hx-get="{{ data_link }}" hx-trigger="load" hx-swap="innerHTML" hx-indicator="#htmx-indicator-loading-status" hx-disabled-elt="#for-pickup-check"></div>
            </div>
        </div>
    </div>
{% endblock %}
