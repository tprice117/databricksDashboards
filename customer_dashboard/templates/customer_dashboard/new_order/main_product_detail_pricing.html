{% extends 'customer_dashboard/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
  Select Supplier
{% endblock %}
{% block stylesheet %}
  <style></style>
{% endblock %}
{% block javascript %}
  <script>
    const discountElement = document.getElementById('discount')
    
    // Prevent multiple requests being made during form submission
    function disableAllButtons() {
      document.querySelectorAll('button').forEach(function (button) {
        button.disabled = true
      })
    }
    
    // create a function for updating the supplier list
    function updateSupplierList(is_delivery) {
      document.querySelectorAll('input[name="is_delivery"]').forEach(function (el) {
        el.setAttribute('value', is_delivery ? 'True' : 'False')
      })
      // Change the pricing modal One Time Charges
      let pricingModalOneTimeCharges = document.getElementById('price-detail-one-time-charges-card')
      if (pricingModalOneTimeCharges) {
        if (is_delivery) {
          pricingModalOneTimeCharges.classList.remove('d-none')
        } else {
          pricingModalOneTimeCharges.classList.add('d-none')
        }
      }
      // Get the parent element
      const parent = document.querySelector('#main-product-detail-pricing-list')
      if (!parent) return
      // Convert the list items into an array
      const itemsArray = Array.from(parent.querySelectorAll('.supplier-item'))
    
      for (let i = 0; i < itemsArray.length; i++) {
        // get data-seller-product-seller-location from the elements
        data_allow_pickup = itemsArray[i].getAttribute('data-allow-pickup')
        // if the checkbox is checked and the data-allow-pickup is false
        itemsArray[i].style.display = ''
        // default to show the freit section
        const freightSection = itemsArray[i].querySelector('.freight-section')
        freightSection.style.display = ''
    
        // show the total
        const displayPriceItems = itemsArray[i].querySelectorAll('#display-price')
        displayPriceItems.forEach(function (displayPrice) {
          const rawPrice = parseFloat(displayPrice.getAttribute('data-price-with-delivery'))
          // change the price attribute
          displayPrice.setAttribute('data-price', rawPrice)
          price = 0.0
          if (rawPrice == NaN) {
            price = 0.0
          } else if (discountElement) {
            const discount = discountElement.value
            price = rawPrice * (1 - discount / 100)
          } else {
            price = rawPrice
          }
          const betterPrice = price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
          displayPrice.textContent = `$${betterPrice}`
        })
    
        // hide distance
        const distance = itemsArray[i].querySelector('.distance-element')
        distance.style.display = 'none'
        if (!is_delivery) {
          // data_allow_pickup is false then remove the element
          if (data_allow_pickup.toLowerCase() === 'false') {
            itemsArray[i].style.display = 'none'
          } else {
            // show distance
            distance.style.display = ''
            // remove a child element with class "freight-section-"
            freightSection.style.display = 'none'
            // show the total without delivery
            displayPriceItems.forEach(function (displayPrice) {
              const rawPrice = parseFloat(displayPrice.getAttribute('data-price-with-delivery')) - parseFloat(displayPrice.getAttribute('data-delivery-price'))
              // change the price attribute
              displayPrice.setAttribute('data-price', rawPrice)
              price = 0.0
              if (rawPrice == NaN) {
                price = 0.0
              } else if (discountElement) {
                const discount = discountElement.value
                price = rawPrice * (1 - discount / 100)
              } else {
                price = rawPrice
              }
              const betterPrice = price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
              displayPrice.textContent = `$${betterPrice}`
            })
          }
        }
      }
    }
    
    function handleDeliveryChange(radio) {
      updateSupplierList(radio.value === 'True')
    }
    
    // Disable the form inputs while htmx request is being sent
    document.body.addEventListener('htmx:beforeSend', function (event) {
      document.getElementById('sort-btn').disabled = true
      if (discountElement) {
        discountElement.disabled = true
      }
      // disable deliveryButton and pickupButton
      document.querySelectorAll('[name=delivery-radio]').forEach(function (el) {
        el.disabled = true
      })
    })
    // Enable the form inputs again after the swap
    document.body.addEventListener('htmx:afterSwap', function (event) {
      document.getElementById('sort-btn').disabled = false
      if (discountElement) {
        discountElement.disabled = false
      }
      // enable deliveryButton and pickupButton
      document.querySelectorAll('[name=delivery-radio]').forEach(function (el) {
        el.disabled = false
      })
    })
    
    // listen for the range slider discount change event
    if (discountElement) {
      discountElement.addEventListener('input', function () {
        // get the value of the range slider
        let discount = this.value
        // get all order-form-discount elements
        let orderFormDiscounts = document.querySelectorAll('.order-form-discount')
        // loop through all order-form-discount elements
        orderFormDiscounts.forEach(function (orderFormDiscount) {
          // update the value of the order-form-discount element
          orderFormDiscount.value = discount
        })
        // get the discountLabel element
        let discountLabel = document.getElementById('discountLabel')
        // update the text of the discountLabel element
        discountLabel.innerText = discount + '%'
        // get all price-item elements
        let priceItems = document.querySelectorAll('.price-item')
        // loop through all price-item elements
        priceItems.forEach(function (priceItem) {
          // get the price of the price-item element
          let price = parseFloat(priceItem.getAttribute('data-price'))
          // check if the price is NaN
          if (isNaN(price)) {
            return
          }
          // calculate the new price
          let newPrice = price * (1 - discount / 100)
          // update the price of the price-item element
          // check if innerText contained a dollar sign
          if (priceItem.innerText.includes('$')) {
            priceItem.innerText = '$' + newPrice.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')
          } else {
            priceItem.innerText = newPrice.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')
          }
        })
      })
    }
    
    function onChatClick(event) {
      // open intercom chat. https://developers.intercom.com/installing-intercom/web/methods
      window.Intercom('showNewMessage')
    }
    
    function sortList() {
      // Get the parent element
      const parent = document.querySelector('#main-product-detail-pricing-list')
      if (!parent) return
    
      // Convert the list items into an array
      const itemsArray = Array.from(parent.querySelectorAll('.supplier-item'))
    
      // Get the selected sort options
      const reverse = document.getElementById('sort-order').value == 'desc'
      const attr = document.getElementById('sort-attribute').value
    
      // Get the valueSelector (the value to sort the elements by)
      let valueSelector
      switch (attr) {
        case 'rating':
          valueSelector = '.rating'
          break
        case 'name':
          valueSelector = '.supplier-name'
          break
        case 'last_checkout':
          valueSelector = '.last-checkout'
          break
        case 'distance':
          valueSelector = '.distance'
          break
        case 'price':
        default:
          valueSelector = '.total-price'
      }
    
      // Sort the array based on the value of the inner element
      itemsArray.sort((a, b) => {
        let aValue, bValue
        if (attr == 'last_checkout') {
          aValue = new Date(a.querySelector(valueSelector).value)
          bValue = new Date(b.querySelector(valueSelector).value)
        } else if (attr == 'name') {
          aValue = a.querySelector(valueSelector).innerText.trim().toLowerCase()
          bValue = b.querySelector(valueSelector).innerText.trim().toLowerCase()
        } else {
          aValue = parseFloat(a.querySelector(valueSelector).value)
          bValue = parseFloat(b.querySelector(valueSelector).value)
        }
        if (aValue < bValue) return reverse ? 1 : -1
        if (aValue > bValue) return reverse ? -1 : 1
        return 0
      })
    
      // Append the sorted elements back to the parent element
      itemsArray.forEach((item) => parent.appendChild(item))
    }
  </script>
{% endblock %}
{% block content %}
  <div class="container-fluid">
    <div class="mx-4">
      <h3 class="text-dark mb-1"><strong>Select a Supplier</strong></h3>
      <div class="row">
        <div class="col">
          {% if request.user.is_staff %}
            <div class="container-sm py-3 px-0">
              <label for="discount" class="form-label text-muted mb-0">Discount <b id="discountLabel">{{ discount|floatformat:2 }}%</b> (Marketplace Discount: {{ market_discount|floatformat:2 }}%)</label>
              <input form="orderForm" type="range" class="form-range form-range-primary" min="0" max="{{ max_discount_100 }}" step="0.1" id="discount" name="discount2" value="{{ discount }}" />
            </div>
          {% endif %}

          <div class="row d-flex align-items-end mb-4">
            <!-- Is Delivery Toggle -->
            <div id="delivery-controls" class="col me-4">
              <div class="btn-group w-100" style="max-width: 400px;">
                <input type="radio" class="btn-check" name="delivery-radio" id="for-delivery-check" autocomplete="off" value="True" onclick="handleDeliveryChange(this);" checked />
                <label class="btn btn-outline-primary px-3" for="for-delivery-check">Delivery</label>
                <input type="radio" class="btn-check" name="delivery-radio" id="for-pickup-check" autocomplete="off" value="False" onclick="handleDeliveryChange(this);" />
                <label class="btn btn-outline-primary px-3" for="for-pickup-check">Pickup</label>
              </div>
            </div>
            <!-- Sorting Controls -->
            <div id="sorting-controls" class="col">
              <div class="d-flex flex-row form-group justify-content-between align-items-end">
                <div class="col me-4" style="min-width: 140px;">
                  <label for="sort-attribute" class="form-label mb-1 text-muted text-nowrap"><small>Sort By</small></label>
                  <select id="sort-attribute" class="form-control border-dark-subtle text-dark" name="sort-attribute">
                    <option value="price">Total Price</option>
                    <option value="distance">Distance</option>
                    <option value="name">Location Name</option>
                    <option value="rating">Rating</option>
                    {% if request.user.is_staff %}
                      <option value="last_checkout">Last Checkout</option>
                    {% endif %}
                  </select>
                </div>
                <div class="col me-4" style="min-width: 140px;">
                  <label for="sort-order" class="form-label mb-1 text-muted text-nowrap"><small>Sort List</small></label>
                  <select id="sort-order" class="form-control border-dark-subtle text-dark" name="sort-order">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                  </select>
                </div>
                <button id="sort-btn" class="btn btn-primary shadow" onclick="sortList()">Go</button>
              </div>
            </div>
          </div>
          <span class="htmx-indicator" id="htmx-indicator-loading-status"><br />Loading <img class="svg-loader" src="{% static 'supplier_dashboard/svg-loaders/bars-blue.svg' %}" /></span>

          <div id="main-product-detail-pricing-list" hx-get="{{ data_link }}" hx-trigger="load" hx-swap="innerHTML" hx-indicator="#htmx-indicator-loading-status" hx-disabled-elt="#for-pickup-check"></div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
